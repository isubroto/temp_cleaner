name: Submit to WinGet

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to submit to WinGet (e.g., 1.0.0)'
        required: true
        type: string

permissions:
  contents: read
  pull-requests: write

jobs:
  submit-to-winget:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set version and validate
        id: version
        run: |
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $version = "${{ github.event.inputs.version }}"
          } else {
            $version = "${{ github.event.release.tag_name }}" -replace '^v', ''
          }
          
          # Validate version format
          if ($version -notmatch '^\d+\.\d+\.\d+(\.\d+)?$') {
            Write-Error "Invalid version format: $version. Expected format: X.Y.Z or X.Y.Z.W"
            exit 1
          }
          
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          Write-Host "âœ… Using version: $version"

      - name: Check MSI availability
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          $msiUrl = "https://github.com/${{ github.repository }}/releases/download/v$version/Temp_Cleaner-$version.msi"
          
          Write-Host "ğŸ” Checking MSI availability at: $msiUrl"
          
          try {
            $response = Invoke-WebRequest -Uri $msiUrl -Method Head -ErrorAction Stop
            Write-Host "âœ… MSI found (Status: $($response.StatusCode))"
          } catch {
            Write-Error "âŒ MSI not found at $msiUrl. Error: $($_.Exception.Message)"
            Write-Host "Please ensure:"
            Write-Host "1. The release v$version is published (not draft)"
            Write-Host "2. The MSI file Temp_Cleaner-$version.msi is attached to the release"
            exit 1
          }

      - name: Download and analyze MSI
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          $msiUrl = "https://github.com/${{ github.repository }}/releases/download/v$version/Temp_Cleaner-$version.msi"
          
          Write-Host "ğŸ“¥ Downloading MSI from: $msiUrl"
          Invoke-WebRequest -Uri $msiUrl -OutFile "TempCleaner.msi" -ErrorAction Stop
          
          # Verify file downloaded correctly
          if (-not (Test-Path "TempCleaner.msi")) {
            Write-Error "âŒ MSI download failed"
            exit 1
          }
          
          $fileSize = (Get-Item "TempCleaner.msi").Length
          Write-Host "âœ… MSI downloaded successfully (Size: $([math]::Round($fileSize/1MB, 2)) MB)"
          
          # Get file hash
          $hash = (Get-FileHash -Path "TempCleaner.msi" -Algorithm SHA256).Hash
          echo "MSI_HASH=$hash" >> $env:GITHUB_ENV
          Write-Host "ğŸ“‹ SHA256 Hash: $hash"
          
          # Extract Product Code from MSI
          Write-Host "ğŸ” Extracting Product Code from MSI..."
          try {
            $installer = New-Object -ComObject WindowsInstaller.Installer
            $database = $installer.GetType().InvokeMember("OpenDatabase", "InvokeMethod", $null, $installer, @("TempCleaner.msi", 0))
            $view = $database.GetType().InvokeMember("OpenView", "InvokeMethod", $null, $database, "SELECT Value FROM Property WHERE Property = 'ProductCode'")
            $view.GetType().InvokeMember("Execute", "InvokeMethod", $null, $view, $null)
            $record = $view.GetType().InvokeMember("Fetch", "InvokeMethod", $null, $view, $null)
            
            if ($record) {
              $productCode = $record.GetType().InvokeMember("StringData", "GetProperty", $null, $record, 1)
              echo "PRODUCT_CODE=$productCode" >> $env:GITHUB_ENV
              Write-Host "âœ… Product Code extracted: $productCode"
              
              # Cleanup COM objects
              [System.Runtime.Interopservices.Marshal]::ReleaseComObject($record) | Out-Null
              [System.Runtime.Interopservices.Marshal]::ReleaseComObject($view) | Out-Null
              [System.Runtime.Interopservices.Marshal]::ReleaseComObject($database) | Out-Null
              [System.Runtime.Interopservices.Marshal]::ReleaseComObject($installer) | Out-Null
            } else {
              throw "No ProductCode found in MSI"
            }
          } catch {
            Write-Host "âš ï¸ Warning: Could not extract ProductCode from MSI: $($_.Exception.Message)"
            Write-Host "Using placeholder GUID - this will need manual correction"
            echo "PRODUCT_CODE={00000000-0000-0000-0000-000000000000}" >> $env:GITHUB_ENV
          }

      - name: Create WinGet manifests
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          $repoUrl = "https://github.com/${{ github.repository }}"
          $msiUrl = "$repoUrl/releases/download/v$version/Temp_Cleaner-$version.msi"
          $hash = "${{ env.MSI_HASH }}"
          $productCode = "${{ env.PRODUCT_CODE }}"
          
          Write-Host "ğŸ“ Creating WinGet manifests for version $version"
          
          # Create manifests directory structure
          $manifestDir = "winget-manifests"
          New-Item -ItemType Directory -Force -Path $manifestDir
          
          # Version manifest
          $versionManifest = @"
        # Created with winget-releaser v2 using Komac v1.11.0
        # yaml-language-server: `$schema=https://aka.ms/winget-manifest.version.1.6.0.schema.json
        
        PackageIdentifier: SubrotoSaha.TempCleaner
        PackageVersion: $version
        DefaultLocale: en-US
        ManifestType: version
        ManifestVersion: 1.6.0
        "@
          
          # Default locale manifest
          $localeManifest = @"
        # Created with winget-releaser v2 using Komac v1.11.0
        # yaml-language-server: `$schema=https://aka.ms/winget-manifest.defaultLocale.1.6.0.schema.json
        
        PackageIdentifier: SubrotoSaha.TempCleaner
        PackageVersion: $version
        PackageLocale: en-US
        Publisher: Subroto Saha
        PublisherUrl: $repoUrl
        PublisherSupportUrl: $repoUrl/issues
        Author: Subroto Saha
        PackageName: TempCleaner
        PackageUrl: $repoUrl
        License: MIT
        LicenseUrl: $repoUrl/blob/main/LICENSE
        Copyright: Copyright (c) 2025 Subroto Saha
        CopyrightUrl: $repoUrl/blob/main/LICENSE
        ShortDescription: A powerful Windows temporary files cleaner
        Description: |-
          TempCleaner is a professional Windows utility that helps you clean temporary files, system cache, and free up disk space. 
          
          Features include:
          - Safe cleaning algorithms
          - Detailed scan reports  
          - Scheduled cleaning options
          - User-friendly interface
          - System optimization tools
        Moniker: tempcleaner
        Tags:
        - cleaner
        - temp-files
        - disk-cleanup
        - system-utility
        - windows
        - maintenance
        - optimization
        - cache-cleaner
        ReleaseNotes: |-
          Release notes for TempCleaner v$version
          
          For detailed changelog and updates, visit the release page.
        ReleaseNotesUrl: $repoUrl/releases/tag/v$version
        PurchaseUrl: $repoUrl
        InstallationNotes: Administrator privileges recommended for full functionality
        Documentations:
        - DocumentLabel: GitHub Repository
          DocumentUrl: $repoUrl
        ManifestType: defaultLocale
        ManifestVersion: 1.6.0
        "@
          
          # Installer manifest
          $installerManifest = @"
        # Created with winget-releaser v2 using Komac v1.11.0
        # yaml-language-server: `$schema=https://aka.ms/winget-manifest.installer.1.6.0.schema.json
        
        PackageIdentifier: SubrotoSaha.TempCleaner
        PackageVersion: $version
        Platform:
        - Windows.Desktop
        MinimumOSVersion: 10.0.0.0
        InstallerType: wix
        Scope: machine
        InstallModes:
        - interactive
        - silent
        - silentWithProgress
        UpgradeBehavior: install
        ReleaseDate: $(Get-Date -Format 'yyyy-MM-dd')
        Installers:
        - Architecture: x64
          InstallerUrl: $msiUrl
          InstallerSha256: $hash
          ProductCode: '$productCode'
          InstallerSwitches:
            Silent: /quiet
            SilentWithProgress: /passive
            InstallLocation: INSTALLDIR="<INSTALLPATH>"
          ExpectedReturnCodes:
          - InstallerReturnCode: 0
            ReturnResponse: installSuccess
          - InstallerReturnCode: 1641
            ReturnResponse: rebootInitiated
          - InstallerReturnCode: 3010
            ReturnResponse: rebootRequiredToFinish
        ManifestType: installer
        ManifestVersion: 1.6.0
        "@
          
          # Write manifests to files
          $versionManifest | Out-File -FilePath "$manifestDir/SubrotoSaha.TempCleaner.yaml" -Encoding UTF8 -NoNewline
          $localeManifest | Out-File -FilePath "$manifestDir/SubrotoSaha.TempCleaner.locale.en-US.yaml" -Encoding UTF8 -NoNewline
          $installerManifest | Out-File -FilePath "$manifestDir/SubrotoSaha.TempCleaner.installer.yaml" -Encoding UTF8 -NoNewline
          
          Write-Host "âœ… WinGet manifests created successfully"
          Write-Host "ğŸ“ Files created:"
          Get-ChildItem $manifestDir | ForEach-Object { Write-Host "   - $($_.Name)" }

      - name: Validate WinGet manifests
        run: |
          Write-Host "ğŸ” Validating WinGet manifests..."
          
          # Check if files exist and have content
          $manifestDir = "winget-manifests"
          $files = @(
            "SubrotoSaha.TempCleaner.yaml",
            "SubrotoSaha.TempCleaner.locale.en-US.yaml", 
            "SubrotoSaha.TempCleaner.installer.yaml"
          )
          
          foreach ($file in $files) {
            $filePath = Join-Path $manifestDir $file
            if (Test-Path $filePath) {
              $content = Get-Content $filePath -Raw
              if ($content.Length -gt 0) {
                Write-Host "âœ… $file - Valid ($($content.Length) characters)"
              } else {
                Write-Error "âŒ $file - Empty file"
                exit 1
              }
            } else {
              Write-Error "âŒ $file - File not found"
              exit 1
            }
          }
          
          Write-Host "âœ… All manifest files validated successfully"

      - name: Upload WinGet manifests as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: winget-manifests-v${{ steps.version.outputs.VERSION }}
          path: winget-manifests/
          retention-days: 30

      - name: Submit to WinGet Community Repository
        uses: vedantmgoyal9/winget-releaser@v2
        with:
          identifier: SubrotoSaha.TempCleaner
          version: ${{ steps.version.outputs.VERSION }}
          installers-regex: '\.msi$'
          token: ${{ secrets.WINGET_TOKEN }}
          fork-user: ${{ secrets.WINGET_FORK_USER }}
          release-tag: v${{ steps.version.outputs.VERSION }}

      - name: Summary
        run: |
          Write-Host ""
          Write-Host "ğŸ‰ WinGet submission completed!"
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host "ğŸ“¦ Package: SubrotoSaha.TempCleaner"
          Write-Host "ğŸ·ï¸  Version: ${{ steps.version.outputs.VERSION }}"
          Write-Host "ğŸ”— Release: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.VERSION }}"
          Write-Host "ğŸ“‹ Hash: ${{ env.MSI_HASH }}"
          Write-Host "ğŸ†” Product Code: ${{ env.PRODUCT_CODE }}"
          Write-Host ""
          Write-Host "ğŸ“ Next steps:"
          Write-Host "   1. Check the PR created in microsoft/winget-pkgs repository"
          Write-Host "   2. Monitor the PR for any feedback from WinGet maintainers"
          Write-Host "   3. Once approved, your package will be available via 'winget install SubrotoSaha.TempCleaner'"
          Write-Host ""
          Write-Host "ğŸ“Š View submission status: https://github.com/microsoft/winget-pkgs/pulls"