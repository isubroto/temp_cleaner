name: Release WPF App with MSI

on:
  push:
    branches:
      - main
    tags:
      - "v*.*.*"
  workflow_dispatch:

permissions:
  contents: write
env:
  project: ./TempCleaner.csproj
jobs:
  release:
    runs-on: windows-latest
    name: Build and Release WPF App with MSI

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.x"

      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v0.11.0
        with:
          versionSpec: "5.x"

      - name: Determine Version
        id: gitversion
        uses: gittools/actions/gitversion/execute@v0.11.0

      - name: Update .csproj Version
        run: |
          $projFile = Get-ChildItem -Recurse -Filter *.csproj | Select-Object -First 1
          $content = Get-Content $projFile.FullName
          if ($content -notmatch '<Version>') {
            $content = $content -replace '</PropertyGroup>', "<Version>${{ steps.gitversion.outputs.FullSemVer }}</Version>`n</PropertyGroup>"
          } else {
            $content = $content -replace '<Version>.*?</Version>', "<Version>${{ steps.gitversion.outputs.FullSemVer }}</Version>"
          }
          Set-Content $projFile.FullName $content

      - name: Restore Dependencies
        run: dotnet restore ${{env.project}} -r win-x64

      - name: build WPF App
        run: dotnet build ${{env.project}} -c Release --no-restore
      - name: publish WPF App
        run: dotnet publish ${{env.project}} -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true --no-build

      - name: Install WiX Toolset
        run: |
          Invoke-WebRequest -Uri https://github.com/wixtoolset/wix/releases/download/v6.0.0/WixAdditionalTools.exe -OutFile wix6.exe
          Start-Process wix6.exe -ArgumentList "/quiet" -Wait
          Remove-Item wix6.exe

      - name: Add WiX Toolset to PATH
        run: |
          echo "Adding WiX Toolset to PATH"
          $env:PATH = "$env:PATH;C:\Program Files (x86)\WiX Toolset v6.0\bin"
          # Test if heat.exe is available
          & "C:\Program Files (x86)\WiX Toolset v6.0\bin\heat.exe" --version
      
      - name: Generate Files.wxs excluding 'publish' folder
        run: |
          & "C:\Program Files (x86)\WiX Toolset v4.0\bin\heat.exe" dir "bin\Release\net8.0-windows\win-x64" `
            -cg AppFiles `
            -dr INSTALLFOLDER `
            -sfrag -srd -gg `
            -var var.SourceDir `
            -out Installer\Files.wxs `
            -t Installer\TransformExcludePublish.xsl

      - name: Build MSI Installer
        working-directory: Installer
        run: |
          # Get version from GitVersion
          $version = "${{ steps.gitversion.outputs.FullSemVer }}"
          
          # Replace '+' with '.' in version to make it safe for file naming
          $safeVersion = $version -replace '\+', '.'
          
          # Set safeVersion as an environment variable for use in subsequent steps
          echo "SAFE_VERSION=$safeVersion" >> $GITHUB_ENV

          # Build the MSI using WiX Toolset (Ensure wix is in PATH or use full path)
          & "C:\Program Files (x86)\WiX Toolset v4.0\bin\wix.exe" build Product.wxs -define ProductVersion=$safeVersion -out "../publish/Temp_Cleaner-$safeVersion.msi"


      - name: Upload Release Artifacts
        uses: softprops/action-gh-release@v2
        with:
          name: Release v${{ env.SAFE_VERSION }}
          tag_name: v${{ env.SAFE_VERSION }}
          files: |
            bin/Release/net8.0-windows/win-x64/publish/*.exe
            publish/**/Temp_Cleaner-${{ env.SAFE_VERSION }}.msi

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
