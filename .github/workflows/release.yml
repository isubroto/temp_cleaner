name: Release WPF App with MSI

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    
permissions:
  contents: write
  

jobs:
  release:
    runs-on: windows-latest
    name: Build and Release WPF App with MSI

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.x'

      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v0.11.0
        with:
          versionSpec: '5.x'

      - name: Determine Version
        id: gitversion
        uses: gittools/actions/gitversion/execute@v0.11.0

      - name: Update .csproj Version
        run: |
          $projFile = Get-ChildItem -Recurse -Filter *.csproj | Select-Object -First 1
          (Get-Content $projFile.FullName) -replace '<Version>.*?</Version>', "<Version>${{ steps.gitversion.outputs.FullSemVer }}</Version>" | Set-Content $projFile.FullName

      - name: Restore Dependencies
        run: dotnet restore

      - name: Publish WPF App
        run: dotnet publish -c Release -o publish

      - name: Install WiX Toolset
        run: |
          choco install wixtoolset --version=4.0.4 -y
          refreshenv

      - name: Build MSI Installer
        run: |
          wix build Installer/Product.wxs -out publish/MyApp-${{ steps.gitversion.outputs.FullSemVer }}.msi

      - name: Upload Release Artifacts
        uses: softprops/action-gh-release@v2
        with:
          name: Release v${{ steps.gitversion.outputs.FullSemVer }}
          tag_name: v${{ steps.gitversion.outputs.FullSemVer }}
          files: |
            publish/**/*.exe
            publish/**/*.msi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
